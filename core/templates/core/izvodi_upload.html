{% extends 'core/base.html' %}

{% block title %}Upload Izvoda - ePau≈°a RS{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-8 px-6">
    
    <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">
            <i class="fas fa-file-upload text-blue-600 mr-3"></i>
            Bulk Upload Bankovnih Izvoda
        </h2>
        
        <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">üìã Uputstvo:</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>‚Ä¢ Mo≈æete upload-ovati do <strong>30 PDF fajlova</strong> odjednom</li>
                <li>‚Ä¢ Sistem ƒáe automatski parsirati sve transakcije (prihode i rashode)</li>
                <li>‚Ä¢ Podr≈æani formati: PDF izvodi iz NLB, UniCredit, Sparkasse</li>
                <li>‚Ä¢ Duplikati ƒáe biti automatski preskaƒçu</li>
            </ul>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-700 mb-3">
                    Odaberite PDF fajlove izvoda (max 30):
                </label>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition"
                     id="dropZone">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Prevucite fajlove ovdje ili kliknite da odaberete</p>
                    
                    <input type="file" name="izvodi" id="izvodiInput" multiple accept="application/pdf"
                           class="hidden" onchange="prikaziFajlove()">
                    
                    <button type="button" onclick="document.getElementById('izvodiInput').click()"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-folder-open mr-2"></i>Odaberi fajlove
                    </button>
                </div>
            </div>
            
            <!-- Lista odabranih fajlova -->
            <div id="fileList" class="hidden mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Odabrani fajlovi:</h3>
                <div id="fileListContent" class="space-y-2"></div>
            </div>
            
            <!-- Submit dugmad -->
            <div class="flex gap-4 justify-end">
                <a href="{% url 'dashboard' %}" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    <i class="fas fa-times mr-2"></i>Otka≈æi
                </a>
                <button type="submit" id="submitBtn" disabled
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>
                    <span id="submitText">Odaberite fajlove</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Progress bar (tokom upload-a) -->
    <div id="progressBar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Obraƒëivanje izvoda...</h3>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                <div id="progressFill" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-center text-gray-600">0%</p>
        </div>
    </div>
</div>

<script>
let selectedFiles = [];

function prikaziFajlove() {
    const input = document.getElementById('izvodiInput');
    selectedFiles = Array.from(input.files);
    
    if (selectedFiles.length > 30) {
        alert('Mo≈æete upload-ovati maksimalno 30 fajlova!');
        selectedFiles = selectedFiles.slice(0, 30);
    }
    
    const fileList = document.getElementById('fileList');
    const fileListContent = document.getElementById('fileListContent');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    
    if (selectedFiles.length > 0) {
        fileList.classList.remove('hidden');
        submitBtn.disabled = false;
        submitText.textContent = `Upload ${selectedFiles.length} fajl(ova)`;
        
        fileListContent.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded';
            fileItem.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-pdf text-red-600 text-xl"></i>
                    <div>
                        <div class="font-medium">${file.name}</div>
                        <div class="text-sm text-gray-500">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                </div>
                <button type="button" onclick="ukloniFajl(${index})" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileListContent.appendChild(fileItem);
        });
    } else {
        fileList.classList.add('hidden');
        submitBtn.disabled = true;
        submitText.textContent = 'Odaberite fajlove';
    }
}

function ukloniFajl(index) {
    selectedFiles.splice(index, 1);
    
    // A≈æuriraj input
    const dataTransfer = new DataTransfer();
    selectedFiles.forEach(file => dataTransfer.items.add(file));
    document.getElementById('izvodiInput').files = dataTransfer.files;
    
    prikaziFajlove();
}

// Drag & Drop funkcionalnost
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
    
    if (files.length > 0) {
        const dataTransfer = new DataTransfer();
        files.slice(0, 30).forEach(file => dataTransfer.items.add(file));
        document.getElementById('izvodiInput').files = dataTransfer.files;
        prikaziFajlove();
    }
});

// Progress bar tokom upload-a
document.getElementById('uploadForm').addEventListener('submit', function() {
    document.getElementById('progressBar').classList.remove('hidden');
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
        }
    }, 200);
    
    // Oƒçisti interval nakon submit-a
    setTimeout(() => clearInterval(interval), 5000);
});
</script>
{% endblock %}