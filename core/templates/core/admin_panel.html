{% extends 'core/base.html' %}
{% block title %}Admin Panel{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold">Admin Portal</h1>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-6">
        <div class="flex border-b">
            <a href="?tab=users"
                class="px-6 py-3 {% if active_tab == 'users' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
                Korisnici ({{ korisnici.count }})
            </a>
            <a href="?tab=parametri"
                class="px-6 py-3 {% if active_tab == 'parametri' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
                <i class="fas fa-cog mr-2"></i>Parametri
            </a>
            <a href="?tab=banke"
                class="px-6 py-3 {% if active_tab == 'banke' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
                <i class="fas fa-university mr-2"></i>Banke
            </a>
            <a href="?tab=logs"
                class="px-6 py-3 {% if active_tab == 'logs' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
                Logs
            </a>
            <a href="?tab=errors"
                class="px-6 py-3 {% if active_tab == 'errors' %}text-blue-600 border-b-2 border-blue-600{% endif %}">
                Errors ({{ failed_requests.count }})
            </a>
        </div>
    </div>

    {% if active_tab == 'parametri' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">
            <i class="fas fa-sliders-h mr-2 text-blue-600"></i>
            Sistemski Parametri
        </h2>

        <form method="post" action="{% url 'admin_parametri_update' %}">
            {% csrf_token %}

            <!-- Doprinosi -->
            <div class="mb-6">
                <div class="bg-blue-50 rounded-lg p-6 border-2 border-blue-200">
                    <label for="mjesecni_doprinosi" class="block text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-wallet mr-2 text-blue-600"></i>
                        Mjeseƒçni Doprinosi (KM)
                    </label>
                    <input type="number" name="mjesecni_doprinosi" id="mjesecni_doprinosi" step="0.01" min="0"
                        value="{{ parametri.mjesecni_doprinosi }}"
                        class="w-full px-4 py-3 text-3xl font-bold text-blue-600 border-2 border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <p class="text-sm text-gray-600 mt-2">
                        Iznos koji se plaƒáa mjeseƒçno za liƒçne doprinose
                    </p>
                </div>
            </div>

            <!-- Prag za malog preduzetnika -->
            <div class="mb-6">
                <div class="bg-yellow-50 rounded-lg p-6 border-2 border-yellow-200">
                    <label for="prag_mali" class="block text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-chart-line mr-2 text-yellow-600"></i>
                        Prag za Malog Preduzetnika (KM godi≈°nje)
                    </label>
                    <input type="number" name="prag_mali_preduzetnik" id="prag_mali" step="0.01" min="0"
                        value="{{ parametri.prag_mali_preduzetnik }}"
                        class="w-full px-4 py-3 text-3xl font-bold text-yellow-600 border-2 border-yellow-300 rounded-md focus:ring-2 focus:ring-yellow-500">
                    <p class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Do ovog iznosa godi≈°njeg prihoda va≈æi stopa 2%, preko ovog iznosa 10%
                    </p>
                </div>
            </div>

            <!-- Poreske Stope -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3">Poreske Stope</h4>

                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Mali preduzetnik -->
                    <div class="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                        <label for="porez_mali" class="block text-sm font-medium text-green-800 mb-2">
                            <i class="fas fa-percentage mr-1"></i>
                            Mali preduzetnik (%)
                        </label>
                        <input type="number" name="porez_mali_preduzetnik" id="porez_mali" step="0.01" min="0"
                            value="{{ parametri.porez_mali_preduzetnik }}"
                            class="w-full px-4 py-2 text-2xl font-bold text-green-600 border border-green-300 rounded-md">
                        <p class="text-xs text-green-700 mt-2">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            Plaƒáa se <b>mjeseƒçno</b>
                        </p>
                    </div>

                    <!-- Veliki preduzetnik -->
                    <div class="bg-purple-50 rounded-lg p-4 border-2 border-purple-200">
                        <label for="porez_veliki" class="block text-sm font-medium text-purple-800 mb-2">
                            <i class="fas fa-percentage mr-1"></i>
                            Veliki preduzetnik (%)
                        </label>
                        <input type="number" name="porez_veliki_preduzetnik" id="porez_veliki" step="0.01" min="0"
                            value="{{ parametri.porez_veliki_preduzetnik }}"
                            class="w-full px-4 py-2 text-2xl font-bold text-purple-600 border border-purple-300 rounded-md">
                        <p class="text-xs text-purple-700 mt-2">
                            <i class="fas fa-calendar mr-1"></i>
                            Plaƒáa se <b>jednom godi≈°nje</b> u martu
                        </p>
                    </div>
                </div>
            </div>

            <!-- Mjesec plaƒáanja -->
            <div class="mb-6">
                <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-200">
                    <label for="mjesec_placanja" class="block text-sm font-medium text-orange-800 mb-2">
                        <i class="fas fa-calendar-day mr-2 text-orange-600"></i>
                        Mjesec plaƒáanja godi≈°njeg poreza (veliki preduzetnik)
                    </label>
                    <select name="mjesec_placanja_poreza" id="mjesec_placanja"
                        class="w-full px-4 py-2 text-lg border-2 border-orange-300 rounded-md">
                        <option value="1" {% if parametri.mjesec_placanja_poreza == 1 %}selected{% endif %}>1 - Januar
                        </option>
                        <option value="2" {% if parametri.mjesec_placanja_poreza == 2 %}selected{% endif %}>2 - Februar
                        </option>
                        <option value="3" {% if parametri.mjesec_placanja_poreza == 3 %}selected{% endif %}>3 - Mart
                        </option>
                        <option value="4" {% if parametri.mjesec_placanja_poreza == 4 %}selected{% endif %}>4 - April
                        </option>
                        <option value="5" {% if parametri.mjesec_placanja_poreza == 5 %}selected{% endif %}>5 - Maj
                        </option>
                        <option value="6" {% if parametri.mjesec_placanja_poreza == 6 %}selected{% endif %}>6 - Jun
                        </option>
                        <option value="7" {% if parametri.mjesec_placanja_poreza == 7 %}selected{% endif %}>7 - Jul
                        </option>
                        <option value="8" {% if parametri.mjesec_placanja_poreza == 8 %}selected{% endif %}>8 - Avgust
                        </option>
                        <option value="9" {% if parametri.mjesec_placanja_poreza == 9 %}selected{% endif %}>9 - Septembar
                        </option>
                        <option value="10" {% if parametri.mjesec_placanja_poreza == 10 %}selected{% endif %}>10 - Oktobar
                        </option>
                        <option value="11" {% if parametri.mjesec_placanja_poreza == 11 %}selected{% endif %}>11 -
                            Novembar</option>
                        <option value="12" {% if parametri.mjesec_placanja_poreza == 12 %}selected{% endif %}>12 -
                            Decembar</option>
                    </select>
                </div>
            </div>

            <!-- Metadata -->
            {% if parametri.zadnje_azurirano %}
            <div class="bg-gray-100 rounded-lg p-3 mb-6 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-2"></i>
                Zadnje a≈æurirano: <b>{{ parametri.zadnje_azurirano|date:"d.m.Y H:i" }}</b>
                {% if parametri.azurirao %}
                od <b>{{ parametri.azurirao.username }}</b>
                {% endif %}
            </div>
            {% endif %}

            <!-- Submit -->
            <div class="flex justify-end gap-3">
                <button type="button" onclick="location.reload()"
                    class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-md transition">
                    <i class="fas fa-times mr-2"></i>
                    Otka≈æi
                </button>

                <button type="submit"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition font-medium">
                    <i class="fas fa-save mr-2"></i>
                    Saƒçuvaj Parametre
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if active_tab == 'banke' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">
                <i class="fas fa-university mr-2 text-blue-600"></i>
                Banke i Raƒçuni
            </h2>
            <button onclick="openAddBankaModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-plus mr-2"></i>
                Dodaj Banku
            </button>
        </div>

        <!-- Info box -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <p class="text-sm text-blue-700">
                <i class="fas fa-info-circle mr-2"></i>
                Svaka banka mora imati <b>2 raƒçuna</b>: jedan za <b>doprinose</b> i drugi za <b>porez</b>.
            </p>
        </div>

        <!-- Lista banaka -->
        <div class="space-y-4">
            {% for banka in banke %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">{{ banka.naziv }}</h3>
                        <p class="text-sm text-gray-500">{{ banka.skraceni_naziv }}</p>
                    </div>
                    <div>
                        {% if banka.aktivna %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-check-circle mr-1"></i> Aktivna
                        </span>
                        {% else %}
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">
                            <i class="fas fa-times-circle mr-1"></i> Neaktivna
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Raƒçuni -->
                <div class="grid md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4">
                    <!-- Doprinosi -->
                    <div class="bg-purple-50 border-l-4 border-purple-400 p-3 rounded">
                        <h4 class="font-bold text-purple-800 mb-2 text-sm">
                            <i class="fas fa-user-shield mr-1"></i> DOPRINOSI
                        </h4>
                        <p class="text-xs text-gray-600 mb-1">Primalac:</p>
                        <p class="font-medium text-sm mb-2">{{ banka.primalac_doprinosi }}</p>
                        <p class="text-xs text-gray-600 mb-1">Raƒçun:</p>
                        <p class="font-mono text-sm font-bold text-purple-600">{{ banka.racun_doprinosi }}</p>
                        {% if banka.poziv_doprinosi %}
                        <p class="text-xs text-gray-500 mt-2">Poziv: {{ banka.poziv_doprinosi }}</p>
                        {% endif %}
                    </div>

                    <!-- Porez -->
                    <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded">
                        <h4 class="font-bold text-orange-800 mb-2 text-sm">
                            <i class="fas fa-percentage mr-1"></i> POREZ
                        </h4>
                        <p class="text-xs text-gray-600 mb-1">Primalac:</p>
                        <p class="font-medium text-sm mb-2">{{ banka.primalac_porez }}</p>
                        <p class="text-xs text-gray-600 mb-1">Raƒçun:</p>
                        <p class="font-mono text-sm font-bold text-orange-600">{{ banka.racun_porez }}</p>
                        {% if banka.poziv_porez %}
                        <p class="text-xs text-gray-500 mt-2">Poziv: {{ banka.poziv_porez }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Akcije -->
                <div class="flex justify-end gap-2 mt-3">
                    <button onclick="editBanka({{ banka.id }})" class="text-blue-600 hover:text-blue-800 px-3 py-1">
                        <i class="fas fa-edit mr-1"></i> Izmijeni
                    </button>
                    <button onclick="toggleBanka({{ banka.id }})" class="text-gray-600 hover:text-gray-800 px-3 py-1">
                        <i class="fas fa-{% if banka.aktivna %}eye-slash{% else %}eye{% endif %} mr-1"></i>
                        {% if banka.aktivna %}Deaktiviraj{% else %}Aktiviraj{% endif %}
                    </button>
                    <button onclick="deleteBanka({{ banka.id }})" class="text-red-600 hover:text-red-800 px-3 py-1">
                        <i class="fas fa-trash mr-1"></i> Obri≈°i
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-university fa-4x mb-4 text-gray-300"></i>
                <p class="text-lg mb-2">Nema dodanih banaka</p>
                <button onclick="openAddBankaModal()" class="text-blue-600 hover:underline">
                    Dodaj prvu banku
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Modal za dodavanje/izmjenu banke -->
    <div id="bankaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold">
                    <i class="fas fa-university mr-2"></i>
                    <span id="modalTitle">Dodaj Novu Banku</span>
                </h3>
                <button onclick="closeBankaModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="bankaForm" method="post" action="{% url 'admin_banka_save' %}" class="p-6">
                {% csrf_token %}
                <input type="hidden" id="banka_id" name="banka_id">

                <!-- Osnovni podaci -->
                <div class="mb-6">
                    <h4 class="font-bold text-gray-700 mb-3 pb-2 border-b">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                        Osnovni Podaci
                    </h4>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Naziv banke *
                            </label>
                            <input type="text" name="naziv" id="naziv" required placeholder="NLB Banka a.d. Banja Luka"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Skraƒáeni naziv *
                            </label>
                            <input type="text" name="skraceni_naziv" id="skraceni_naziv" required placeholder="NLB"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>

                <!-- DOPRINOSI -->
                <div class="mb-6">
                    <h4 class="font-bold text-purple-700 mb-3 pb-2 border-b border-purple-200">
                        <i class="fas fa-user-shield mr-2"></i>
                        Raƒçun za Doprinose
                    </h4>

                    <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                        <div class="grid md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Primalac *
                                </label>
                                <input type="text" name="primalac_doprinosi" id="primalac_doprinosi" required
                                    value="PORESKA UPRAVA REPUBLIKE SRPSKE"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Raƒçun *
                                </label>
                                <input type="text" name="racun_doprinosi" id="racun_doprinosi" required
                                    placeholder="5551111111111111" maxlength="30"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Poziv na broj (opciono)
                                </label>
                                <input type="text" name="poziv_doprinosi" id="poziv_doprinosi" maxlength="50"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Svrha (template)
                                </label>
                                <input type="text" name="svrha_doprinosi_template" id="svrha_doprinosi_template"
                                    value="Liƒçni doprinosi za {mjesec}/{godina}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">Koristi {mjesec} i {godina}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POREZ -->
                <div class="mb-6">
                    <h4 class="font-bold text-orange-700 mb-3 pb-2 border-b border-orange-200">
                        <i class="fas fa-percentage mr-2"></i>
                        Raƒçun za Porez
                    </h4>

                    <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                        <div class="grid md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Primalac *
                                </label>
                                <input type="text" name="primalac_porez" id="primalac_porez" required
                                    value="PORESKA UPRAVA REPUBLIKE SRPSKE"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Raƒçun *
                                </label>
                                <input type="text" name="racun_porez" id="racun_porez" required
                                    placeholder="5552222222222222" maxlength="30"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Poziv na broj (opciono)
                                </label>
                                <input type="text" name="poziv_porez" id="poziv_porez" maxlength="50"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Svrha (template)
                                </label>
                                <input type="text" name="svrha_porez_template" id="svrha_porez_template"
                                    value="Porez na prihod za {godina}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">Koristi {mjesec} i {godina}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" name="aktivna" id="aktivna" checked
                            class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">Aktivna banka</span>
                    </label>
                </div>

                <!-- Dugmad -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeBankaModal()"
                        class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-md">
                        Otka≈æi
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                        <i class="fas fa-save mr-2"></i>
                        Saƒçuvaj
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if active_tab == 'users' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Pretraga -->
        <div class="mb-6">
            <form method="get" class="flex gap-4">
                <input type="hidden" name="tab" value="users">
                <div class="flex-1">
                    <input type="text" name="search" value="{{ search_query }}"
                        placeholder="üîé Pretra≈æi po imenu, emailu ili JIB-u..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-search mr-2"></i>Pretra≈æi
                </button>
                {% if search_query %}
                <a href="?tab=users" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    <i class="fas fa-times mr-2"></i>Resetuj
                </a>
                {% endif %}
            </form>

            {% if search_query %}
            <p class="mt-2 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                Pronaƒëeno <strong>{{ korisnici.count }}</strong> rezultata za "<strong>{{ search_query }}</strong>"
            </p>
            {% endif %}
        </div>

        <!-- Legenda statusa -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6 flex flex-wrap gap-4 text-sm">
            <div class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                <span class="text-gray-700"><strong>Trial Active</strong> - Trail period aktivan</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                <span class="text-gray-700"><strong>Paid</strong> - Plaƒáena pretplata</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                <span class="text-gray-700"><strong>Ended</strong> - Pretplata istekla</span>
            </div>
            <div class="flex items-center">
                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                <span class="text-gray-700"><i class="fas fa-star text-xs"></i> Trail produ≈æen</span>
            </div>
        </div>

        <!-- Tabela -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ime</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Plan</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">JIB</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Subscription
                            Status</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    {% if korisnici %}
                    {% for korisnik in korisnici %}
                    <tr class="border-t hover:bg-gray-50 transition-colors">
                        <!-- Ime -->
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">{{ korisnik.ime }}</div>
                            <div class="text-xs text-gray-500">
                                Registrovan: {{ korisnik.registrovan|date:"d.m.Y" }}
                            </div>
                        </td>

                        <!-- Email -->
                        <td class="px-4 py-3">
                            <div class="text-sm text-gray-600">{{ korisnik.user.email }}</div>
                        </td>

                        <!-- Plan -->
                        <td class="px-4 py-3">
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                {{ korisnik.plan }}
                            </span>
                        </td>

                        <!-- JIB -->
                        <td class="px-4 py-3">
                            <span class="text-sm font-mono text-gray-700">{{ korisnik.jib }}</span>
                        </td>

                        <!-- Subscription Status -->
                        <td class="px-4 py-3">
                            {% if korisnik.je_trial %}
                            <!-- TRIAL ACTIVE -->
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center">
                                    <span
                                        class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm font-medium inline-flex items-center">
                                        <i class="fas fa-clock mr-2"></i>
                                        Trial Active
                                    </span>
                                    {% if korisnik.is_trial_extended %}
                                    <span
                                        class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold">
                                        <i class="fas fa-star mr-1"></i>Produ≈æen
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-600">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Istiƒçe: <strong class="text-gray-800">{{ korisnik.datum_isteka_triala|date:"d.m.Y" }}</strong>
                                </div>
                                <div class="text-xs font-semibold text-green-600">
                                    {{ korisnik.dani_info }}
                                </div>
                            </div>
                            {% else %}
                            <!-- Provjera da li ima trial_end_date i da li je istekao -->
                            {% if korisnik.trial_end_date %}
                            <!-- Expired check -->
                            <div class="flex flex-col gap-1">
                                <span
                                    class="px-3 py-1 bg-red-100 text-red-800 rounded-lg text-sm font-medium inline-flex items-center w-fit">
                                    <i class="fas fa-times-circle mr-2"></i>
                                    Ended
                                </span>
                                <div class="text-xs text-gray-600">
                                    Istekao: <strong class="text-red-700">{{ korisnik.datum_isteka_triala|date:"d.m.Y" }}</strong>
                                </div>
                            </div>
                            {% else %}
                            <!-- PAID (nemaju trail_end_date) -->
                            <span
                                class="px-3 py-1 bg-purple-100 text-purple-800 rounded-lg text-sm font-medium inline-flex items-center">
                                <i class="fas fa-crown mr-2"></i>
                                Paid Subscription
                            </span>
                            {% endif %}
                            {% endif %}
                        </td>

                        <!-- Akcije -->
                        <td class="px-4 py-3">
                            <div class="flex items-center justify-center gap-2">
                                {% if korisnik.je_trial %}
                                <!-- Produ≈æi Trial - za active trial -->
                                <button
                                    onclick="openExtendTrialModal({{ korisnik.user.id }}, '{{ korisnik.ime }}', '{{ korisnik.datum_isteka_triala|date:'d.m.Y' }}', true)"
                                    class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-medium transition-colors"
                                    title="Produ≈æi trail period">
                                    <i class="fas fa-clock mr-1"></i>Produ≈æi
                                </button>
                                {% else %}
                                {% if korisnik.trial_end_date %}
                                <!-- Reaktiviraj - za ended -->
                                <button
                                    onclick="openExtendTrialModal({{ korisnik.user.id }}, '{{ korisnik.ime }}', '{{ korisnik.datum_isteka_triala|date:'d.m.Y' }}', false)"
                                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors"
                                    title="Reaktiviraj trail period">
                                    <i class="fas fa-redo mr-1"></i>Reaktiviraj
                                </button>
                                {% endif %}
                                {% endif %}

                                <!-- Login As -->
                                <a href="{% url 'admin_login_as' korisnik.user.id %}"
                                    class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors"
                                    title="Login kao ovaj korisnik">
                                    <i class="fas fa-sign-in-alt mr-1"></i>Login
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <!-- Empty state -->
                    <tr>
                        <td colspan="6" class="px-4 py-12 text-center text-gray-500">
                            <i class="fas fa-users-slash text-5xl mb-3 opacity-30"></i>
                            <p class="text-lg font-medium">Nema korisnika</p>
                            {% if search_query %}
                            <p class="text-sm mt-1">Nema rezultata za pretragu "{{ search_query }}"</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Statistika -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-green-600 font-medium">Trail Active</p>
                        <p class="text-2xl font-bold text-green-700" id="trial-active-count">0</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-green-300"></i>
                </div>
            </div>

            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-purple-600 font-medium">Paid</p>
                        <p class="text-2xl font-bold text-purple-700" id="paid-count">0</p>
                    </div>
                    <i class="fas fa-crown text-3xl text-purple-300"></i>
                </div>
            </div>

            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-red-600 font-medium">Ended</p>
                        <p class="text-2xl font-bold text-red-700" id="ended-count">0</p>
                    </div>
                    <i class="fas fa-times-circle text-3xl text-red-300"></i>
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-blue-600 font-medium">Ukupno</p>
                        <p class="text-2xl font-bold text-blue-700">{{ korisnici.count }}</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal za produ≈æavanje trail perioda -->
    <div id="extendTrialModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div id="modalHeader" class="bg-yellow-500 text-white p-4 flex justify-between items-center rounded-t-lg">
                <h3 class="text-xl font-bold">
                    <i class="fas fa-clock mr-2"></i>
                    <span id="modalTitleText">Produ≈æi Trail Period</span>
                </h3>
                <button onclick="closeExtendTrialModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="extendTrialForm" class="p-6">
                {% csrf_token %}
                <input type="hidden" id="extend_user_id" name="user_id">
                <input type="hidden" id="is_active_trial" name="is_active_trial">

                <div class="mb-4">
                    <p class="text-gray-700 mb-2">
                        Korisnik: <strong id="extend_user_name" class="text-gray-900"></strong>
                    </p>
                    <p class="text-sm text-gray-600">
                        <span id="currentDateLabel">Trenutni datum isteka:</span>
                        <strong id="extend_current_date" class="text-gray-800"></strong>
                    </p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Broj dana produ≈æenja:
                    </label>
                    <select name="days" id="extend_days"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-500">
                        <option value="7">7 dana</option>
                        <option value="14">14 dana</option>
                        <option value="30" selected>30 dana (1 mjesec)</option>
                        <option value="60">60 dana (2 mjeseca)</option>
                        <option value="90">90 dana (3 mjeseca)</option>
                        <option value="180">180 dana (6 mjeseci)</option>
                        <option value="365">365 dana (1 godina)</option>
                    </select>
                </div>

                <div id="infoBox" class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-6">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="infoText">Trail period ƒáe biti produ≈æen od trenutnog datuma isteka.</span>
                    </p>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeExtendTrialModal()"
                        class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-md transition-colors">
                        Otka≈æi
                    </button>
                    <button type="submit" id="submitBtn"
                        class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-medium transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        <span id="submitBtnText">Produ≈æi Trail</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    {% if active_tab == 'logs' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl mb-4 font-semibold">System Logs</h2>

        <!-- Pretraga logova -->
        <div class="mb-6">
            <form method="get" class="flex gap-4">
                <input type="hidden" name="tab" value="logs">
                <div class="flex-1">
                    <input type="text" name="log_search" value="{{ log_search }}"
                        placeholder="üîé Pretra≈æi po emailu, akciji ili IP adresi..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-search mr-2"></i>Pretra≈æi
                </button>
                {% if log_search %}
                <a href="?tab=logs" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    <i class="fas fa-times mr-2"></i>Resetuj
                </a>
                {% endif %}
            </form>

            {% if log_search %}
            <p class="mt-2 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                Pronaƒëeno <strong>{{ logs.count }}</strong> rezultata za "<strong>{{ log_search }}</strong>"
            </p>
            {% endif %}
        </div>

        <div class="space-y-2">
            {% for log in logs %}
            <div
                class="p-3 bg-gray-50 rounded border-l-4 {% if log.status == 'success' %}border-green-500{% else %}border-red-500{% endif %}">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-sm text-gray-500">{{ log.timestamp|date:"d.m.Y H:i" }}</span>
                        <span class="mx-2">‚Ä¢</span>
                        <span class="font-medium">
                            {% if log.user %}
                            {{ log.user.email }}
                            {% else %}
                            <span class="text-gray-400">System</span>
                            {% endif %}
                        </span>
                        <span class="mx-2">‚Ä¢</span>
                        <span class="text-sm">{{ log.action }}</span>
                        {% if log.ip_address %}
                        <span class="mx-2">‚Ä¢</span>
                        <span class="text-xs text-gray-400 font-mono">{{ log.ip_address }}</span>
                        {% endif %}
                    </div>
                    <span
                        class="px-2 py-1 {% if log.status == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %} rounded text-xs font-semibold">
                        {{ log.status|upper }}
                    </span>
                </div>
                {% if log.details %}
                <p class="text-xs text-gray-600 mt-1">{{ log.details }}</p>
                {% endif %}
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-4xl mb-2 opacity-30"></i>
                <p>Nema rezultata{% if log_search %} za "{{ log_search }}"{% endif %}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if active_tab == 'errors' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl mb-4 font-semibold">Failed Requests</h2>
        {% for req in failed_requests %}
        <div class="border rounded p-4 bg-red-50 mb-3">
            <div class="flex justify-between items-start mb-2">
                <p class="font-semibold text-red-800">{{ req.action }}</p>
                <span class="text-xs text-gray-500">{{ req.timestamp|date:"d.m.Y H:i" }}</span>
            </div>
            <p class="text-sm text-red-600 mb-3">{{ req.error }}</p>
            <div class="flex gap-2">
                {% if req.retryable %}
                <button onclick="retryRequest({{ req.id }})"
                    class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    <i class="fas fa-redo mr-1"></i>Retry
                </button>
                {% endif %}
                <button onclick="skipRequest({{ req.id }})"
                    class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">
                    <i class="fas fa-times mr-1"></i>Skip
                </button>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-check-circle text-4xl mb-2 opacity-30"></i>
            <p>Nema failed requests</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    async function retryRequest(id) {
        const response = await fetch(`/admin/retry/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await response.json();
        if (data.success) {
            alert('‚úÖ Request uspje≈°an!');
            window.location.reload();
        } else {
            alert('‚ùå Request neuspje≈°an');
        }
    }

    async function skipRequest(id) {
        const response = await fetch(`/admin/skip/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        if ((await response.json()).success) {
            alert('‚úÖ Preskoƒçen');
            window.location.reload();
        }
    }

    function openAddBankaModal() {
        document.getElementById('modalTitle').textContent = 'Dodaj Novu Banku';
        document.getElementById('banka_id').value = '';
        document.getElementById('bankaForm').reset();
        // Postavi default vrijednosti
        document.getElementById('primalac_doprinosi').value = 'PORESKA UPRAVA REPUBLIKE SRPSKE';
        document.getElementById('primalac_porez').value = 'PORESKA UPRAVA REPUBLIKE SRPSKE';
        document.getElementById('svrha_doprinosi_template').value = 'Liƒçni doprinosi za {mjesec}/{godina}';
        document.getElementById('svrha_porez_template').value = 'Porez na prihod za {godina}';
        document.getElementById('bankaModal').classList.remove('hidden');
    }

    function closeBankaModal() {
        document.getElementById('bankaModal').classList.add('hidden');
    }

    function editBanka(id) {
        fetch(`/admin-panel/banka/${id}/`)
            .then(r => {
                console.log('Response:', r);
                return r.json();
            })
            .then(data => {
                console.log('Data:', data);
                document.getElementById('modalTitle').textContent = 'Izmijeni Banku';
                document.getElementById('banka_id').value = data.id;
                document.getElementById('naziv').value = data.naziv;
                document.getElementById('skraceni_naziv').value = data.skraceni_naziv;
                document.getElementById('racun_doprinosi').value = data.racun_doprinosi;
                document.getElementById('racun_porez').value = data.racun_porez;
                document.getElementById('primalac_doprinosi').value = data.primalac_doprinosi;
                document.getElementById('primalac_porez').value = data.primalac_porez;
                document.getElementById('poziv_doprinosi').value = data.poziv_doprinosi || '';
                document.getElementById('poziv_porez').value = data.poziv_porez || '';
                document.getElementById('svrha_doprinosi_template').value = data.svrha_doprinosi_template;
                document.getElementById('svrha_porez_template').value = data.svrha_porez_template;
                document.getElementById('aktivna').checked = data.aktivna;
                document.getElementById('bankaModal').classList.remove('hidden');
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Gre≈°ka pri uƒçitavanju banke');
            });
    }

    function toggleBanka(id) {
        if (confirm('Promijeniti status banke?')) {
            fetch(`/admin-panel/banka/${id}/toggle/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    }

    function deleteBanka(id) {
        if (confirm('Da li ste sigurni da ≈æelite obrisati ovu banku?')) {
            fetch(`/admin-panel/banka/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Banka obrisana');
                        location.reload();
                    }
                });
        }
    }

    function openExtendTrialModal(userId, userName, currentDate, isActiveTrial) {
        document.getElementById('extend_user_id').value = userId;
        document.getElementById('extend_user_name').textContent = userName;
        document.getElementById('extend_current_date').textContent = currentDate;
        document.getElementById('is_active_trial').value = isActiveTrial;

        // Prilagodi UI na osnovu statusa
        const modalHeader = document.getElementById('modalHeader');
        const modalTitle = document.getElementById('modalTitleText');
        const currentDateLabel = document.getElementById('currentDateLabel');
        const infoText = document.getElementById('infoText');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnText = document.getElementById('submitBtnText');
        const infoBox = document.getElementById('infoBox');

        if (isActiveTrial) {
            // Active Trail
            modalHeader.className = 'bg-yellow-500 text-white p-4 flex justify-between items-center rounded-t-lg';
            modalTitle.innerHTML = '<i class="fas fa-clock mr-2"></i>Produ≈æi Trail Period';
            currentDateLabel.textContent = 'Trenutni datum isteka:';
            infoText.textContent = 'Trail period ƒáe biti produ≈æen od trenutnog datuma isteka.';
            submitBtn.className = 'px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-medium transition-colors';
            submitBtnText.textContent = 'Produ≈æi Trail';
            infoBox.className = 'bg-blue-50 border-l-4 border-blue-400 p-3 mb-6';
        } else {
            // Ended Subscription - Reaktivacija
            modalHeader.className = 'bg-red-500 text-white p-4 flex justify-between items-center rounded-t-lg';
            modalTitle.innerHTML = '<i class="fas fa-redo mr-2"></i>Reaktiviraj Pretplatu';
            currentDateLabel.textContent = 'Datum isteka:';
            infoText.textContent = 'Pretplata je istekla. Novi trail period ƒáe poƒçeti od danas.';
            submitBtn.className = 'px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md font-medium transition-colors';
            submitBtnText.textContent = 'Reaktiviraj';
            infoBox.className = 'bg-red-50 border-l-4 border-red-400 p-3 mb-6';
        }

        document.getElementById('extendTrialModal').classList.remove('hidden');
    }

    function closeExtendTrialModal() {
        document.getElementById('extendTrialModal').classList.add('hidden');
        document.getElementById('extendTrialForm').reset();
    }

    // Submit Trail Extension
    document.getElementById('extendTrialForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const userId = document.getElementById('extend_user_id').value;
        const days = document.getElementById('extend_days').value;
        const isActiveTrial = document.getElementById('is_active_trial').value === 'true';
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const submitBtn = document.getElementById('submitBtn');
        const originalBtnText = submitBtn.innerHTML;

        // Disable button i prika≈æi loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesiranje...';

        try {
            const response = await fetch(`/admin-panel/extend-trial/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `days=${days}`
            });

            const data = await response.json();

            if (data.success) {
                const actionText = isActiveTrial ? 'produ≈æen' : 'reaktiviran';
                alert(`‚úÖ Trail period uspje≈°no ${actionText} za ${data.days_added} dana!\n\nüóìÔ∏è Novi datum isteka: ${data.new_date}`);
                closeExtendTrialModal();
                location.reload();
            } else {
                alert('‚ùå Gre≈°ka: ' + (data.error || 'Nepoznata gre≈°ka'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Gre≈°ka pri produ≈æavanju trail perioda. Poku≈°ajte ponovo.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeExtendTrialModal();
        }
    });

    // Close modal on outside click
    document.getElementById('extendTrialModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeExtendTrialModal();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('tbody tr');
        let trialCount = 0;
        let paidCount = 0;
        let endedCount = 0;

        rows.forEach(row => {
            const statusCell = row.querySelector('td:nth-child(5)');
            if (statusCell) {
                const text = statusCell.textContent;
                if (text.includes('Trial Active')) trialCount++;
                else if (text.includes('Paid Subscription')) paidCount++;
                else if (text.includes('Ended')) endedCount++;
            }
        });

        document.getElementById('trial-active-count').textContent = trialCount;
        document.getElementById('paid-count').textContent = paidCount;
        document.getElementById('ended-count').textContent = endedCount;
    });
</script>
{% endblock %}