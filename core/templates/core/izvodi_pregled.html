{% extends 'core/base.html' %}

{% block title %}Pregled Izvoda - ePau≈°a RS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-6">

    <!-- Header sa filterom -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-file-invoice-dollar text-blue-600"></i>
                    Izvodi - Prihodi i Rashodi
                </h2>
                <p class="text-sm text-gray-500 mt-1">
                    Ukupno: {{ ukupno_transakcija }} transakcija
                </p>
            </div>
            <a href="{% url 'izvodi_upload' %}"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <i class="fas fa-upload"></i>
                <span>Upload Izvoda</span>
            </a>
        </div>

        <!-- Quick Period Filters -->
        <div class="mb-4 flex items-center gap-2 flex-wrap">
            <span class="text-sm font-medium text-gray-700 mr-2">Brzi filter:</span>

            <!-- Ova godina (default) -->
            <a href="{% url 'izvodi_pregled' %}"
                class="px-3 py-1.5 rounded-lg text-sm font-medium transition 
               {% if od_datum == ova_godina_start and not do_datum %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-calendar-check mr-1"></i>Ova godina
            </a>

            <!-- Ovaj mjesec -->
            <a href="?od={{ trenutni_mjesec_start }}&do={{ trenutni_mjesec_end }}"
                class="px-3 py-1.5 rounded-lg text-sm font-medium transition
               {% if od_datum == trenutni_mjesec_start and do_datum == trenutni_mjesec_end %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-calendar mr-1"></i>Ovaj mjesec
            </a>

            <!-- Pro≈°li mjesec -->
            <a href="?od={{ prosli_mjesec_start }}&do={{ prosli_mjesec_end }}"
                class="px-3 py-1.5 rounded-lg text-sm font-medium transition
               {% if od_datum == prosli_mjesec_start and do_datum == prosli_mjesec_end %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-calendar-minus mr-1"></i>Pro≈°li mjesec
            </a>

            <!-- Pro≈°la godina -->
            <a href="?od={{ prosla_godina_start }}&do={{ prosla_godina_end }}"
                class="px-3 py-1.5 rounded-lg text-sm font-medium transition
               {% if od_datum == prosla_godina_start and do_datum == prosla_godina_end %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-history mr-1"></i>Pro≈°la godina
            </a>
        </div>

        <!-- Filter -->
        <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Od datuma</label>
                <input type="date" name="od" value="{{ od_datum }}"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Do datuma</label>
                <input type="date" name="do" value="{{ do_datum }}"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-end gap-2">
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-filter"></i>
                    <span>Filtriraj</span>
                </button>
                <a href="{% url 'izvodi_pregled' %}"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 flex items-center gap-2">
                    <i class="fas fa-redo"></i>
                    <span>Reset</span>
                </a>
            </div>
        </form>

        <!-- Info o filteru -->
        {% if od_datum and do_datum %}
        <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-1"></i>
                Prikazano:
                {% if od_datum == do_datum|slice:":7"|add:"-01" and do_datum >= od_datum|slice:":7"|add:"-28" %}
                <strong>Trenutni mjesec</strong> ({{ od_datum|date:"F Y" }})
                {% else %}
                <strong>{{ od_datum|date:"d.m.Y" }}</strong> - <strong>{{ do_datum|date:"d.m.Y" }}</strong>
                {% endif %}
                <a href="{% url 'izvodi_pregled' %}?per_page={{ per_page }}"
                    class="ml-3 text-blue-600 hover:text-blue-800 underline">
                    Prika≈æi sve
                </a>
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Statistika -->
    <div class="grid grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Ukupno Prihodi</p>
                    <p class="text-3xl font-bold text-green-600">+{{ ukupno_prihodi|floatformat:2 }} KM</p>
                </div>
                <i class="fas fa-arrow-up text-5xl text-green-200"></i>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Ukupno Rashodi</p>
                    <p class="text-3xl font-bold text-red-600">-{{ ukupno_rashodi|floatformat:2 }} KM</p>
                </div>
                <i class="fas fa-arrow-down text-5xl text-red-200"></i>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Bilans</p>
                    <p class="text-3xl font-bold {% if bilans >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                        {{ bilans|floatformat:2 }} KM
                    </p>
                </div>
                <i class="fas fa-balance-scale text-5xl text-blue-200"></i>
            </div>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="mb-4 flex justify-between items-center p-3 bg-white rounded-lg shadow-md border border-gray-200">
        <div class="text-sm text-gray-600">
            {% if per_page == 'all' %}
            Prikazano: <strong>{{ ukupno_transakcija }}</strong> od {{ ukupno_transakcija }}
            {% else %}
            Prikazano:
            <strong>{{ page_obj.start_index }}</strong> - <strong>{{ page_obj.end_index }}</strong>
            od <strong>{{ ukupno_transakcija }}</strong>
            {% endif %}
        </div>

        <div class="flex items-center gap-4">
            <!-- Per Page Selector -->
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-700">Prika≈æi:</label>
                <select name="per_page" onchange="changePerPage(this.value)"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                    <option value="40" {% if per_page == '40' %}selected{% endif %}>40</option>
                    <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                    <option value="all" {% if per_page == 'all' %}selected{% endif %}>Sve</option>
                </select>
            </div>

            <!-- Pagination Buttons -->
            {% if paginator %}
            <div class="flex items-center gap-1">
                {% if page_obj.has_previous %}
                <a href="?page=1{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                    <i class="fas fa-angle-left"></i>
                </a>
                {% endif %}

                <span class="px-4 py-1.5 text-sm font-medium">
                    Stranica {{ page_obj.number }} od {{ paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ paginator.num_pages }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tabela transakcija -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left">Datum</th>
                        <th class="px-4 py-3 text-left">Opis</th>
                        <th class="px-4 py-3 text-center">Vrsta</th>
                        <th class="px-4 py-3 text-right">Iznos</th>
                        <th class="px-4 py-3 text-center">PDF</th>
                        <th class="px-4 py-3 text-center">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in transakcije %}
                    <tr class="border-t hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ trans.datum|date:"d.m.Y" }}
                        </td>
                        <td class="px-4 py-3">
                            {{ trans.opis|truncatewords:10 }}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if trans.vrsta == 'prihod' %}
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-up mr-1"></i>Prihod
                            </span>
                            {% else %}
                            <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-down mr-1"></i>Rashod
                            </span>
                            {% endif %}
                        </td>
                        <td
                            class="px-4 py-3 text-right font-bold {% if trans.vrsta == 'prihod' %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if trans.vrsta == 'prihod' %}
                            +{{ trans.iznos|floatformat:2 }} KM
                            {% else %}
                            -{{ trans.iznos|floatformat:2 }} KM
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if trans.izvod_fajl %}
                            <a href="{{ trans.izvod_fajl.url }}" target="_blank"
                                class="text-red-600 hover:text-red-800 text-lg">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button
                                onclick="obrisiTransakciju({{ trans.id }}, '{{ trans.opis|truncatewords:5|escapejs }}')"
                                class="text-red-600 hover:text-red-800 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Nema transakcija. Upload-ujte bankovne izvode!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bottom Pagination -->
    {% if paginator and paginator.num_pages > 1 %}
    <div class="mt-4 flex justify-center">
        <div class="flex items-center gap-1">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                <i class="fas fa-angle-left"></i>
            </a>
            {% endif %}

            <!-- Page Numbers -->
            {% for num in paginator.page_range %}
            {% if num == page_obj.number %}
            <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a
                href="?page={{ num }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                {{ num }}
                </a>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ paginator.num_pages }}{% if od_datum %}&od={{ od_datum }}{% endif %}{% if do_datum %}&do={{ do_datum }}{% endif %}&per_page={{ per_page }}"
                    class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    function obrisiTransakciju(izvodId, opis) {
        if (confirm(`üóëÔ∏è Da li ste sigurni da ≈æelite obrisati:\n\n"${opis}..."\n\nOva akcija se NE MO≈ΩE poni≈°titi!`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/izvodi/${izvodId}/delete/`;

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            document.body.appendChild(form);
            form.submit();
        }
    }

    function changePerPage(value) {
        const url = new URL(window.location);
        url.searchParams.set('per_page', value);
        url.searchParams.delete('page'); // Reset na prvu stranicu
        window.location = url;
    }
</script>
{% endblock %}