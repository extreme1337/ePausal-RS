{% extends 'core/base.html' %}

{% block title %}Fakture - ePau≈°a RS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-file-invoice text-blue-600"></i>
                    Fakture
                </h2>
                <p class="text-sm text-gray-500 mt-1">
                    Ukupno: {{ ukupno }} faktura | Vrijednost: {{ ukupan_iznos }} KM
                </p>
            </div>
            <button onclick="toggleNewInvoice()"
                class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Nova faktura</span>
            </button>
        </div>

        <!-- Search & Filter Bar -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i>
                        Pretraga
                    </label>
                    <input type="text" name="search" value="{{ search_query }}"
                        placeholder="Broj fakture ili naziv primaoca..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-filter mr-1"></i>
                        Status
                    </label>
                    <select name="status"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Svi statusi</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Valuta Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-money-bill mr-1"></i>
                        Valuta
                    </label>
                    <select name="valuta"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Sve valute</option>
                        {% for value, label in valuta_choices %}
                        <option value="{{ value }}" {% if valuta_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Buttons -->
                <div class="md:col-span-4 flex gap-2">
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-search"></i>
                        <span>Pretra≈æi</span>
                    </button>

                    {% if search_query or status_filter or valuta_filter %}
                    <a href="{% url 'fakture' %}"
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition flex items-center gap-2">
                        <i class="fas fa-times"></i>
                        <span>Resetuj</span>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Search Results Info -->
        {% if search_query or status_filter or valuta_filter %}
        <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-1"></i>
                <strong>{{ ukupno }}</strong> rezultata pronaƒëeno
                {% if search_query %}
                za "<strong>{{ search_query }}</strong>"
                {% endif %}
                {% if status_filter %}
                <span class="mx-1">‚Ä¢</span> Status: <strong>{{ status_filter }}</strong>
                {% endif %}
                {% if valuta_filter %}
                <span class="mx-1">‚Ä¢</span> Valuta: <strong>{{ valuta_filter }}</strong>
                {% endif %}
            </p>
        </div>
        {% endif %}

        <!-- Pagination Controls -->
        <div class="mb-4 flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="text-sm text-gray-600">
                {% if per_page == 'all' %}
                Prikazano: <strong>{{ ukupno }}</strong> od {{ ukupno }}
                {% else %}
                Prikazano:
                <strong>{{ page_obj.start_index }}</strong> - <strong>{{ page_obj.end_index }}</strong>
                od <strong>{{ ukupno }}</strong>
                {% endif %}
            </div>

            <div class="flex items-center gap-4">
                <!-- Per Page Selector -->
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Prika≈æi:</label>
                    <select name="per_page" onchange="changePerPage(this.value)"
                        class="px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                        <option value="40" {% if per_page == '40' %}selected{% endif %}>40</option>
                        <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                        <option value="all" {% if per_page == 'all' %}selected{% endif %}>Sve</option>
                    </select>
                </div>

                <!-- Pagination Buttons -->
                {% if paginator %}
                <div class="flex items-center gap-1">
                    {% if page_obj.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if valuta_filter %}&valuta={{ valuta_filter }}{% endif %}&per_page={{ per_page }}"
                        class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if valuta_filter %}&valuta={{ valuta_filter }}{% endif %}&per_page={{ per_page }}"
                        class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                        <i class="fas fa-angle-left"></i>
                    </a>
                    {% endif %}

                    <span class="px-4 py-1.5 text-sm font-medium">
                        Stranica {{ page_obj.number }} od {{ paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if valuta_filter %}&valuta={{ valuta_filter }}{% endif %}&per_page={{ per_page }}"
                        class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if valuta_filter %}&valuta={{ valuta_filter }}{% endif %}&per_page={{ per_page }}"
                        class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-sm">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Nova Faktura Form -->
        <div id="newInvoiceForm" class="hidden mb-6 border-2 border-blue-200 rounded-lg bg-blue-50">
            <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg">
                <h3 class="font-bold text-lg">Kreiranje nove fakture</h3>
            </div>

            <form method="POST" id="invoiceForm" class="p-6 space-y-6">
                {% csrf_token %}

                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">üìÑ Osnovni podaci</h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Broj fakture *</label>
                            <input type="text" name="broj_fakture" placeholder="F001/25" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Datum izdavanja *</label>
                            <input type="date" name="datum_izdavanja" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto izdavanja</label>
                            <input type="text" name="mjesto_izdavanja" placeholder="Trebinje, BiH"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">üè¢ Izdavalac (Va≈°a firma)</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Naziv firme *</label>
                            <input type="text" name="izdavalac_naziv"
                                placeholder='Computer programming "KRATOS" Marko Mi≈°eljiƒá s.p.' required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adresa *</label>
                            <input type="text" name="izdavalac_adresa" placeholder="Todoriƒái br.2" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto *</label>
                            <input type="text" name="izdavalac_mjesto" placeholder="89101 Trebinje" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">JIB *</label>
                            <input type="text" name="izdavalac_jib" placeholder="4512358123456" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                            <input type="text" name="izdavalac_iban" placeholder="BA12 1234 2000 0000 9904"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank account *</label>
                            <input type="text" name="izdavalac_racun" placeholder="567-123-00000123-30" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">üë§ Primalac (Kupac)</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Naziv *</label>
                            <input type="text" name="primalac_naziv" placeholder="ALIANZA INC" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adresa *</label>
                            <input type="text" name="primalac_adresa" placeholder="1064 S NORTH COUNTY BLVD SUITE 500"
                                required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto *</label>
                            <input type="text" name="primalac_mjesto" placeholder="PLEASANT GROVE, USA" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="primalac_jib" class="block text-sm font-medium text-gray-700 mb-2">
                            JIB - <span class="text-xs text-gray-500">(opcionalno)</span>
                        </label>
                        <input type="text" name="primalac_jib" id="primalac_jib" maxlength="13" pattern="[0-9]{13}"
                            placeholder="4400123456789"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 font-mono">
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h4 class="font-semibold text-gray-700">üìã Stavke fakture</h4>
                        <button type="button" onclick="dodajStavku()"
                            class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-1"></i>Dodaj stavku
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300" id="stavkeTable">
                            <thead class="bg-gray-700 text-white text-sm">
                                <tr>
                                    <th class="border border-gray-300 px-2 py-2 w-12">Num.</th>
                                    <th class="border border-gray-300 px-2 py-2">Description *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-24">Unit *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-24">Qty *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-32">Price *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-32">Total</th>
                                    <th class="border border-gray-300 px-2 py-2 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="stavkeBody">
                                <tr class="stavka-row">
                                    <td class="border border-gray-300 px-2 py-2 text-center">
                                        <span class="redni-broj font-semibold">1.</span>
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="text" name="stavke[0][opis]" required
                                            class="w-full px-2 py-1 border rounded text-sm"
                                            placeholder="Programming services">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="text" name="stavke[0][jedinica]" required
                                            class="w-full px-2 py-1 border rounded text-center text-sm" value="unit">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="number" name="stavke[0][kolicina]" required min="0.01" step="0.01"
                                            class="w-full px-2 py-1 border rounded text-center kolicina text-sm"
                                            value="1">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="number" name="stavke[0][cijena]" required min="0" step="0.01"
                                            class="w-full px-2 py-1 border rounded text-right cijena text-sm"
                                            placeholder="0.00">
                                    </td>
                                    <td
                                        class="border border-gray-300 px-2 py-2 text-right font-bold ukupno-stavka text-blue-600">
                                        0.00
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">
                                        <button type="button" onclick="obrisiStavku(this)"
                                            class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-gray-100 italic">
                                <tr>
                                    <td colspan="5" class="border border-gray-300 px-4 py-4 text-right">
                                        <div class="flex items-center justify-end gap-3">
                                            <span id="totalLabel" class="font-bold text-lg text-gray-700">UKUPNA CIJENA
                                                U
                                                BAM:</span>
                                            <select name="valuta" id="valuta"
                                                class="border p-2 rounded bg-white font-bold text-blue-600 focus:ring-2 focus:ring-blue-500">
                                                <option value="BAM">BAM (KM)</option>
                                                <option value="EUR">EUR (‚Ç¨)</option>
                                                <option value="USD">USD ($)</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td class="border border-gray-300 px-2 py-4 text-right font-bold text-xl text-blue-600"
                                        id="grandTotal">
                                        0.00 BAM
                                    </td>
                                    <td class="border border-gray-300"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="flex gap-2 justify-end">
                    <button type="button" onclick="toggleNewInvoice()"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-times mr-2"></i>Otka≈æi
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                        <i class="fas fa-save mr-2"></i>Saƒçuvaj i generi≈°i
                    </button>
                </div>
            </form>
        </div>

        <!-- Fakture Lista -->
        {% if fakture.count == 0 %}
        <div class="text-center py-16 text-gray-500">
            <i class="fas fa-file-invoice text-6xl mb-4 opacity-30"></i>
            {% if search_query or status_filter or valuta_filter %}
            <p class="text-lg">Nema rezultata za va≈°u pretragu</p>
            <p class="text-sm mt-2">Poku≈°ajte sa drugim uslovima pretrage</p>
            {% else %}
            <p class="text-lg">Nemate kreiranih faktura</p>
            <p class="text-sm mt-2">Kliknite "Nova Faktura" da kreirate prvu</p>
            {% endif %}
        </div>
        {% else %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left">Broj</th>
                        <th class="px-4 py-2 text-left">Datum</th>
                        <th class="px-4 py-2 text-left">Primalac</th>
                        <th class="px-4 py-2 text-right">Iznos</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-center">Promijeni Status</th>
                        <th class="px-4 py-2 text-center">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    {% for faktura in fakture %}
                    <tr class="border-t hover:bg-gray-50 transition">
                        <td class="px-4 py-3 font-mono text-sm font-bold">{{ faktura.broj_fakture }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ faktura.datum_izdavanja|date:"d.m.Y" }}</td>
                        <td class="px-4 py-3">{{ faktura.primalac_naziv }}</td>
                        <td class="px-4 py-3 text-right font-semibold text-blue-600">
                            {{ faktura.ukupno_bez_pdv }} {{ faktura.valuta }}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase 
                                {% if faktura.status == 'paid' %}bg-green-100 text-green-700
                                {% elif faktura.status == 'issued' %}bg-blue-100 text-blue-700
                                {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ faktura.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <select onchange="promijeniStatus({{ faktura.id }}, this.value)" class="text-xs font-bold rounded-full px-2 py-1 border cursor-pointer focus:outline-none 
                                {% if faktura.status == 'paid' %} bg-green-50 text-green-700 border-green-200
                                {% elif faktura.status == 'issued' %} bg-blue-50 text-blue-700 border-blue-200
                                {% else %} bg-yellow-50 text-yellow-700 border-yellow-200 {% endif %}">
                                <option value="issued" {% if faktura.status == 'issued' %}selected{% endif %}>Izdato
                                </option>
                                <option value="paid" {% if faktura.status == 'paid' %}selected{% endif %}>Plaƒáeno</option>
                                <option value="cancelled" {% if faktura.status == 'cancelled' %}selected{% endif %}>
                                    Otkazano</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <a href="{% url 'download_invoice' faktura.id %}" target="_blank"
                                class="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs transition">
                                <i class="fas fa-download"></i> Preuzmi
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<script>
    let stavkaCount = 1;

    function toggleNewInvoice() {
        const form = document.getElementById('newInvoiceForm');
        form.classList.toggle('hidden');

        if (!form.classList.contains('hidden')) {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="datum_izdavanja"]').value = today;
            izracunajUkupno();
        }
    }

    function dodajStavku() {
        const tbody = document.getElementById('stavkeBody');
        const newRow = document.createElement('tr');
        newRow.className = 'stavka-row';
        newRow.innerHTML = `
            <td class="border border-gray-300 px-2 py-2 text-center">
                <span class="redni-broj font-semibold">${stavkaCount + 1}.</span>
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="stavke[${stavkaCount}][opis]" required 
                       class="w-full px-2 py-1 border rounded text-sm"
                       placeholder="Description">
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="stavke[${stavkaCount}][jedinica]" required 
                       class="w-full px-2 py-1 border rounded text-center text-sm"
                       value="unit">
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="number" name="stavke[${stavkaCount}][kolicina]" required min="0.01" step="0.01"
                       class="w-full px-2 py-1 border rounded text-center kolicina text-sm"
                       value="1">
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="number" name="stavke[${stavkaCount}][cijena]" required min="0" step="0.01"
                       class="w-full px-2 py-1 border rounded text-right cijena text-sm"
                       placeholder="0.00">
            </td>
            <td class="border border-gray-300 px-2 py-2 text-right font-bold ukupno-stavka text-blue-600">
                0.00
            </td>
            <td class="border border-gray-300 px-2 py-2 text-center">
                <button type="button" onclick="obrisiStavku(this)" 
                        class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);

        newRow.querySelectorAll('.kolicina, .cijena').forEach(input => {
            input.addEventListener('input', () => izracunajStavku(newRow));
        });

        stavkaCount++;
        azurirajRedneBrojeve();
    }

    function obrisiStavku(button) {
        const tbody = document.getElementById('stavkeBody');
        if (tbody.querySelectorAll('tr').length > 1) {
            button.closest('tr').remove();
            azurirajRedneBrojeve();
            izracunajUkupno();
        } else {
            alert('Mora postojati najmanje jedna stavka!');
        }
    }

    function azurirajRedneBrojeve() {
        document.querySelectorAll('.redni-broj').forEach((span, index) => {
            span.textContent = (index + 1) + '.';
        });
    }

    function izracunajStavku(row) {
        const kolicina = parseFloat(row.querySelector('.kolicina').value) || 0;
        const cijena = parseFloat(row.querySelector('.cijena').value) || 0;
        const ukupno = kolicina * cijena;
        row.querySelector('.ukupno-stavka').textContent = ukupno.toFixed(2);
        izracunajUkupno();
    }

    function izracunajUkupno() {
        let total = 0;
        const valuta = document.getElementById('valuta').value;

        document.querySelectorAll('.stavka-row').forEach(row => {
            const kolicina = parseFloat(row.querySelector('.kolicina').value) || 0;
            const cijena = parseFloat(row.querySelector('.cijena').value) || 0;
            total += (kolicina * cijena);
        });

        document.getElementById('grandTotal').textContent = total.toFixed(2) + ' ' + valuta;
        document.getElementById('totalLabel').textContent = `UKUPNA CIJENA ${valuta}:`;
    }

    function promijeniStatus(fakturaId, noviStatus) {
        fetch(`/fakture/${fakturaId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'status': noviStatus })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Gre≈°ka: ' + (data.error || 'Nepoznata gre≈°ka'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Do≈°lo je do gre≈°ke na serveru.');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('valuta').addEventListener('change', izracunajUkupno);

        document.querySelectorAll('.kolicina, .cijena').forEach(input => {
            input.addEventListener('input', function () {
                izracunajStavku(this.closest('tr'));
            });
        });

        izracunajUkupno();
    });

    document.getElementById('invoiceForm').addEventListener('submit', function (e) {
        const stavke = document.querySelectorAll('.stavka-row');
        if (stavke.length === 0) {
            e.preventDefault();
            alert('Morate dodati najmanje jednu stavku!');
        }
    });

    function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.delete('page'); // Reset na prvu stranicu
    window.location = url;
}
</script>
{% endblock %}