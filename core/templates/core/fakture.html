{% extends 'core/base.html' %}

{% block title %}Fakture - ePau코a RS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">
                <i class="fas fa-file-invoice mr-2 text-blue-600"></i>
                Fakture
            </h2>
            <button onclick="toggleNewInvoice()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-plus mr-2"></i>Nova faktura
            </button>
        </div>

        <!-- New Invoice Form - PROIRENA VERZIJA -->
        <div id="newInvoiceForm" class="hidden mb-6 border-2 border-blue-200 rounded-lg bg-blue-50">
            <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg">
                <h3 class="font-bold text-lg">Kreiranje nove fakture</h3>
            </div>

            <form method="POST" id="invoiceForm" class="p-6 space-y-6">
                {% csrf_token %}

                <!-- Osnovni podaci -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">游늯 Osnovni podaci</h4>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Broj fakture *</label>
                            <input type="text" name="broj_fakture" placeholder="F001/25" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Datum izdavanja *</label>
                            <input type="date" name="datum_izdavanja" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto izdavanja</label>
                            <input type="text" name="mjesto_izdavanja" placeholder="Trebinje, BiH"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Izdavalac -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">游끽 Izdavalac (Va코a firma)</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Naziv firme *</label>
                            <input type="text" name="izdavalac_naziv"
                                placeholder='Computer programming "KRATOS" Marko Mi코elji캖 s.p.' required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adresa *</label>
                            <input type="text" name="izdavalac_adresa" placeholder="Todori캖i br.2" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto *</label>
                            <input type="text" name="izdavalac_mjesto" placeholder="89101 Trebinje" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">JIB *</label>
                            <input type="text" name="izdavalac_jib" placeholder="4512358123456" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                            <input type="text" name="izdavalac_iban" placeholder="BA12 1234 2000 0000 9904"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank account *</label>
                            <input type="text" name="izdavalac_racun" placeholder="567-123-00000123-30" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Primalac -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">游녻 Primalac (Kupac)</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Naziv *</label>
                            <input type="text" name="primalac_naziv" placeholder="ALIANZA INC" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adresa *</label>
                            <input type="text" name="primalac_adresa" placeholder="1064 S NORTH COUNTY BLVD SUITE 500"
                                required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mjesto *</label>
                            <input type="text" name="primalac_mjesto" placeholder="PLEASANT GROVE" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="primalac_jib" class="block text-sm font-medium text-gray-700 mb-2">
                            <!-- <i class="fas fa-id-card mr-1 text-blue-600"></i> -->
                            JIB - <span class="text-xs text-gray-500">(opcionalno)</span>
                        </label>
                        <input type="text" name="primalac_jib" id="primalac_jib" maxlength="13" pattern="[0-9]{13}"
                            placeholder="4400123456789"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 font-mono">
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Unesite 13-cifreni JIB broj firme ako izdajete fakturu za firmu
                        </p>
                    </div>
                </div>

                <!-- Stavke -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h4 class="font-semibold text-gray-700">游늶 Stavke fakture</h4>
                        <button type="button" onclick="dodajStavku()"
                            class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-1"></i>Dodaj stavku
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300" id="stavkeTable">
                            <thead class="bg-gray-700 text-white text-sm">
                                <tr>
                                    <th class="border border-gray-300 px-2 py-2 w-12">Num.</th>
                                    <th class="border border-gray-300 px-2 py-2">Description *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-24">Unit *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-24">Qty *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-32">Price *</th>
                                    <th class="border border-gray-300 px-2 py-2 w-32">Total</th>
                                    <th class="border border-gray-300 px-2 py-2 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="stavkeBody">
                                <tr class="stavka-row">
                                    <td class="border border-gray-300 px-2 py-2 text-center">
                                        <span class="redni-broj font-semibold">1.</span>
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="text" name="stavke[0][opis]" required
                                            class="w-full px-2 py-1 border rounded text-sm"
                                            placeholder="Programming services">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="text" name="stavke[0][jedinica]" required
                                            class="w-full px-2 py-1 border rounded text-center text-sm" value="unit">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="number" name="stavke[0][kolicina]" required min="0.01" step="0.01"
                                            class="w-full px-2 py-1 border rounded text-center kolicina text-sm"
                                            value="1">
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <input type="number" name="stavke[0][cijena]" required min="0" step="0.01"
                                            class="w-full px-2 py-1 border rounded text-right cijena text-sm"
                                            placeholder="2459.73">
                                    </td>
                                    <td
                                        class="border border-gray-300 px-2 py-2 text-right font-bold ukupno-stavka text-blue-600">
                                        0.00
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2 text-center">
                                        <button type="button" onclick="obrisiStavku(this)"
                                            class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td colspan="5" class="border border-gray-300 px-2 py-3 text-right font-bold">
                                        Ukupna cijena KM:
                                    </td>
                                    <td class="border border-gray-300 px-2 py-3 text-right font-bold text-xl text-blue-600"
                                        id="grandTotal">
                                        0.00 KM
                                    </td>
                                    <td class="border border-gray-300"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Dugmad -->
                <div class="flex gap-2 justify-end">
                    <button type="button" onclick="toggleNewInvoice()"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-times mr-2"></i>Otka쬴
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                        <i class="fas fa-download mr-2"></i>Generi코i i preuzmi
                    </button>
                </div>
            </form>
        </div>

        <!-- Invoices Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left">Broj</th>
                        <th class="px-4 py-2 text-left">Datum</th>
                        <th class="px-4 py-2 text-left">Primalac</th>
                        <th class="px-4 py-2 text-right">Iznos</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-center">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    {% for faktura in fakture %}
                    <tr class="border-t hover:bg-gray-50 transition">
                        <td class="px-4 py-3 font-mono text-sm">{{ faktura.broj_fakture }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ faktura.datum_izdavanja|date:"d.m.Y" }}</td>
                        <td class="px-4 py-3">{{ faktura.primalac_naziv }}</td>
                        <td class="px-4 py-3 text-right font-semibold">{{ faktura.ukupno_bez_pdv }} {{ faktura.valuta }}
                        </td>
                        <td class="px-4 py-3">
                            <span
                                class="px-3 py-1 rounded-full text-sm {% if faktura.status == 'paid' %}bg-green-100 text-green-700{% elif faktura.status == 'issued' %}bg-blue-100 text-blue-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ faktura.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <select onchange="promijeniStatus({{ faktura.id }}, this.value)" class="text-xs font-bold rounded-full px-3 py-1 border cursor-pointer focus:ring-2 focus:ring-blue-400
                                    {% if faktura.status == 'paid' %} bg-green-100 text-green-700 border-green-200
                                    {% elif faktura.status == 'issued' %} bg-blue-100 text-blue-700 border-blue-200
                                    {% else %} bg-yellow-100 text-yellow-700 border-yellow-200 {% endif %}">
                                <option value="issued" {% if faktura.status == 'issued' %}selected{% endif %}>Izdato
                                </option>
                                <option value="paid" {% if faktura.status == 'paid' %}selected{% endif %}>Pla캖eno</option>
                                <option value="cancelled" {% if faktura.status == 'cancelled' %}selected{% endif %}>
                                    Otkazano</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <a href="{% url 'download_invoice' faktura.id %}" target="_blank"
                                class="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition">
                                <i class="fas fa-download"></i>Preuzmi
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Nema kreiranih faktura</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let stavkaCount = 1;

    function toggleNewInvoice() {
        const form = document.getElementById('newInvoiceForm');
        form.classList.toggle('hidden');

        // Postavi dana코nji datum
        if (!form.classList.contains('hidden')) {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="datum_izdavanja"]').value = today;
        }
    }

    function dodajStavku() {
        const tbody = document.getElementById('stavkeBody');
        const newRow = document.createElement('tr');
        newRow.className = 'stavka-row';
        newRow.innerHTML = `
        <td class="border border-gray-300 px-2 py-2 text-center">
            <span class="redni-broj font-semibold">${stavkaCount + 1}.</span>
        </td>
        <td class="border border-gray-300 px-2 py-2">
            <input type="text" name="stavke[${stavkaCount}][opis]" required 
                   class="w-full px-2 py-1 border rounded text-sm"
                   placeholder="Description">
        </td>
        <td class="border border-gray-300 px-2 py-2">
            <input type="text" name="stavke[${stavkaCount}][jedinica]" required 
                   class="w-full px-2 py-1 border rounded text-center text-sm"
                   value="unit">
        </td>
        <td class="border border-gray-300 px-2 py-2">
            <input type="number" name="stavke[${stavkaCount}][kolicina]" required min="0.01" step="0.01"
                   class="w-full px-2 py-1 border rounded text-center kolicina text-sm"
                   value="1">
        </td>
        <td class="border border-gray-300 px-2 py-2">
            <input type="number" name="stavke[${stavkaCount}][cijena]" required min="0" step="0.01"
                   class="w-full px-2 py-1 border rounded text-right cijena text-sm"
                   placeholder="0.00">
        </td>
        <td class="border border-gray-300 px-2 py-2 text-right font-bold ukupno-stavka text-blue-600">
            0.00
        </td>
        <td class="border border-gray-300 px-2 py-2 text-center">
            <button type="button" onclick="obrisiStavku(this)" 
                    class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
        tbody.appendChild(newRow);
        stavkaCount++;

        // Event listeneri
        const inputs = newRow.querySelectorAll('.kolicina, .cijena');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                izracunajStavku(this.closest('tr'));
            });
        });

        azurirajRedneBrojeve();
    }

    // Funkcija za promenu statusa
    function promijeniStatus(fakturaId, noviStatus) {
        // URL putanja mora biti ta캜na kao u urls.py
        const url = `/fakture/${fakturaId}/status/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Django 캖e ovo zamijeniti tokenom
            },
            body: JSON.stringify({
                'status': noviStatus
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Mre쬹a gre코ka');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Umjesto reload-a, mo쬰mo samo vizuelno potvrditi, 
                    // ali reload je najsigurniji da se osvje쬰 boje iz Django templejta
                    window.location.reload();
                } else {
                    alert('Gre코ka: ' + (data.error || 'Nepoznata gre코ka'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Do코lo je do gre코ke pri komunikaciji sa serverom.');
            });
    }

    function obrisiStavku(button) {
        const tbody = document.getElementById('stavkeBody');
        const row = button.closest('tr');

        if (tbody.querySelectorAll('tr').length > 1) {
            row.remove();
            azurirajRedneBrojeve();
            izracunajUkupno();
        } else {
            alert('Mora postojati najmanje jedna stavka!');
        }
    }

    function azurirajRedneBrojeve() {
        document.querySelectorAll('.redni-broj').forEach((span, index) => {
            span.textContent = (index + 1) + '.';
        });
    }

    function izracunajStavku(row) {
        const kolicina = parseFloat(row.querySelector('.kolicina').value) || 0;
        const cijena = parseFloat(row.querySelector('.cijena').value) || 0;
        const ukupno = kolicina * cijena;

        row.querySelector('.ukupno-stavka').textContent = ukupno.toFixed(2);
        izracunajUkupno();
    }

    function izracunajUkupno() {
        let total = 0;

        document.querySelectorAll('.stavka-row').forEach(row => {
            const kolicina = parseFloat(row.querySelector('.kolicina').value) || 0;
            const cijena = parseFloat(row.querySelector('.cijena').value) || 0;
            total += (kolicina * cijena);
        });

        document.getElementById('grandTotal').textContent = total.toFixed(2) + 'KM';
    }

    // Init
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.kolicina, .cijena').forEach(input => {
            input.addEventListener('input', function () {
                izracunajStavku(this.closest('tr'));
            });
        });

        izracunajUkupno();
    });

    // Form submit
    document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validacija
        const stavke = document.querySelectorAll('.stavka-row');
        if (stavke.length === 0) {
            alert('Morate dodati najmanje jednu stavku!');
            return;
        }

        // Submit formu normalno (bez AJAX)
        e.target.submit();
    });
</script>
{% endblock %}